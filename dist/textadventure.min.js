function Player(t,e){this.inventory=t,this.location=e}function TextAdventure(t,e,i,o,n){this.locations={},this.newGameLocations=JSON.stringify(i),this.newStartingInventory=JSON.stringify(n),this.victoryConditions=o,this.options=e,this.player,this.extensions,this.usedObjects=[],this.promptMode=!1,this.currentPrompt=[],this.gameVictory=!1,this.container,this.containername=t,this.outputContainer,this.inputField,this.tutorialMessages=[],this.tutorialMessageCount=0,this.firstMessageDisplayed=!1,this.timer,this.timerInterval=10,this.typedCommands=[],this.typedCommandsIndex=0,this.storage,this.canStore=!1,this.debug("***** LOADING GAME *****"),this.debug("Initializing text adventure"),void 0!==this.options.height&&"number"!=typeof this.options.height&&(this.options.height=void 0);try{this.storage=window.localStorage;var s="__storage_test__";this.storage.setItem(s,s),this.storage.removeItem(s),this.canStore=!0,this.debug("Browser is localStorage capable"),Storage.prototype.setObject=function(t,e){this.setItem(t,JSON.stringify(e))},Storage.prototype.getObject=function(t){return JSON.parse(this.getItem(t))}}catch(t){this.canStore=!1}void 0!==this.options.tutorial_messages?this.tutorialMessages=this.options.tutorial_messages:this.tutorialMessages=["To play, type an instruction or command followed by the RETURN key.","Have a look in your inventory to see what you are currently carrying.","If you are stuck, examine your current location or an object for hints.","Use the UP and DOWN arrow keys to view previously typed instructions."],this.container=document.getElementById(t),this.debug("Preparing container with game elements"),this.container.innerHTML="",this.outputContainer=document.createElement("div"),this.outputContainer.className="dal-ta-output",this.container.appendChild(this.outputContainer);var r=document.createElement("div");r.className="dal-ta-input",this.inputField=document.createElement("input"),this.inputField.type="text",this.inputField.name="dal-ta-inputfield",this.inputField.placeholder=this.tutorialMessages[this.tutorialMessageCount],this.inputField.autofocus=!0,this.inputField.focus(),this.inputField.addEventListener("keypress",function(t){13===t.keyCode&&(this.parseCommand(t.target.value),this.inputField.value="")}.bind(this),!0),this.inputField.addEventListener("keydown",function(t){38===t.keyCode&&this.showTypedCommand(-1),40===t.keyCode&&this.showTypedCommand(1)}.bind(this),!0),r.appendChild(this.inputField),this.container.appendChild(r),void 0!==this.options.height&&(this.container.style.height=this.options.height+"px",this.outputContainer.style.height=this.options.height-r.clientHeight+"px"),this.start()}Player.prototype.getLocation=function(){return this.location},Player.prototype.setLocation=function(t){this.location=t},Player.prototype.inInventory=function(t){for(var e in this.inventory)if(e===t||this.inventory[e].name===t)return!0;return!1},Player.prototype.addItemToInventory=function(t,e){this.inventory[t]=e},Player.prototype.deleteItemFromInventory=function(t){delete this.inventory[t]},Player.prototype.getItemFromInventory=function(t){for(var e in this.inventory)if(e===t||this.inventory[e].name===t)return this.inventory[e]},Player.prototype.getItemIDFromInventory=function(t){for(var e in this.inventory)if(this.inventory[e].name===t)return e},Player.prototype.getInventory=function(){return this.inventory},Player.prototype.setInventory=function(t){this.inventory=t},TextAdventure.prototype.start=function(){if(this.printLine("<h2>"+this.options.title+"</h2>","title"),this.printLine(this.options.description,"description"),this.options.show_help&&this.displayHelp(),this.canStore&&null!==this.storage.getItem("TA_CURRENTLOCATION"))for(var t in this.debug("Local save found, resuming save."),this.printLine("... Resuming game from previous save","info"),this.locations=this.storage.getObject("TA_LOCATIONS"),this.player=new Player(this.storage.getObject("TA_INVENTORY"),this.storage.getItem("TA_CURRENTLOCATION")),this.locations)for(var e in this.locations[t].objects)this.locations[t].objects[e].is_used&&this.usedObjects.push(e);else this.debug("No local save available, setting up new game"),this.locations=JSON.parse(this.newGameLocations),console.log(this.locations),console.log(this.locations.startlocation),this.player=new Player(JSON.parse(this.newStartingInventory),this.locations.startlocation);this.checkForVictory(),this.gameVictory||(console.log(this.locations.start),console.log(this.player),this.printLine(this.locations[this.player.getLocation()].text_on_visit),this.locations[this.player.getLocation()].visited=!0,this.currentPrompt=[],this.checkForPrompt("this.locations."+this.player.getLocation()+".prompts"))},TextAdventure.prototype.parseCommand=function(command){var actionTaken=!1;if(this.debug("***** COMMAND *****"),this.debug("Received command : "+command),command=command.toLowerCase().trim(),this.promptMode){this.debug("Game in prompt mode."),this.debug("Checking input against valid prompt responses.");var responseObj={},validResponseFound=!1,nextPromptToCheck="",promptObj=eval(this.getCurrentPrompt()[0]+"."+this.getCurrentPrompt()[1]);for(var response in promptObj.responses)if(!actionTaken){this.debug("Checking response: "+response),responseObj=promptObj.responses[response];for(var found=!1,i=0;!found&&i<responseObj.valid_commands.length;)command===responseObj.valid_commands[i]&&(found=!0),i++;found&&(this.debug("Proper response found"),this.printLine(responseObj.response_text),actionTaken=!0,this.promptMode=!1,this.trigger(responseObj,"response_trigger"),eval(this.getCurrentPrompt()[0]+"."+this.getCurrentPrompt()[1]).has_prompted=!0,eval(this.getCurrentPrompt()[0]+"."+this.getCurrentPrompt()[1]).responses[response].is_chosen=!0,void 0!==responseObj.receive_object&&""!==responseObj.receive_object&&(this.debug("Receiving object "+responseObj.receive_object),this.player.addItemToInventory(responseObj.receive_object,this.locations[this.player.getLocation()].objects[responseObj.receive_object]),this.printLine(this.locations[this.player.getLocation()].objects[responseObj.receive_object].text_on_pickup)),void 0!==responseObj.goto_location&&""!==responseObj.goto_location?(this.resetPrompts(),nextPromptToCheck="",this.moveToLocation(responseObj.goto_location)):(nextPromptToCheck=this.getCurrentPrompt()[0]+"."+this.getCurrentPrompt()[1]+".responses."+response+".prompts",this.checkForPrompt(nextPromptToCheck),this.prepareNextTurn(command,actionTaken)))}actionTaken||this.printLine("This wasn't a valid response.","error")}else{var matchLength=0;if("help"===command)this.displayHelp();else if("inventory"===command)this.displayInventory();else if("look around"===command)this.printLine(this.locations[this.player.getLocation()].description);else if(-1!==command.search(/^(pick up|take|grab)\s/)){matchLength=command.match(/^(pick up|take|grab)\s/)[0].length;var pickedupObject=command.substring(matchLength).replace("the ","");actionTaken=this.validatePickup(pickedupObject)}else if(-1!==command.search(/^(examine|look at)\s/)){matchLength=command.match(/^(examine|look at)\s/)[0].length;var examinedObject=command.substring(matchLength).replace("the ","");this.validateExamine(examinedObject)}else if(-1!==command.search(/^(go|move)\s/)){matchLength=command.match(/^((?:go|move)(?:\sto)?)\s/)[0].length;var direction=command.substring(matchLength).replace("the ","");actionTaken=this.validateMoveDirection(direction)}else if(-1!==command.search(/^(use)\s/)){var test1=/^(?:use)\s(.*)(?:\son\s)(.*)/,test2=/^(?:use)\s(.*)/,results=[];-1!==command.search(test1)?(results=command.match(test1),actionTaken=this.validateUse(results[1].replace("the ",""),results[2].replace("the ",""))):(results=command.match(test2),actionTaken=this.validateUse(results[1].replace("the ",""),""))}else this.printLine("That instruction wasn't understood.","error")}this.prepareNextTurn(command,actionTaken)},TextAdventure.prototype.prepareNextTurn=function(t,e){this.tutorialMessageCount++,this.tutorialMessageCount<this.tutorialMessages.length?this.inputField.placeholder=this.tutorialMessages[this.tutorialMessageCount]:this.inputField.placeholder="",this.typedCommands.push(t),this.typedCommandsIndex=this.typedCommands.length,e?(this.canStore&&(this.debug("Actionable turn, saving progress"),this.saveProgress()),this.debug("Actionable turn, checking for victory"),this.checkForVictory()):this.debug("Not an actionable turn, no need to save or check for victory")},TextAdventure.prototype.validateMoveDirection=function(t){this.debug("Testing direction "+t+" for validity");var e,i,o=!1;for(var n in this.locations[this.player.getLocation()].directions)n===t?(o=!0,e=n):(i=this.locations[this.player.getLocation()].directions[n].location,this.locations[i].name.toLowerCase()===t&&(o=!0,e=n));return o?this.resolvedDependency(e)?(moveToLocation(this.locations[this.player.getLocation()].directions[e].location),!0):(this.debug("Access to this location is blocked"),this.printLine(this.locations[this.player.getLocation()].directions[e].text_on_error,"error"),!1):(printLine("That is not a possible direction.","error"),!1)},TextAdventure.prototype.moveToLocation=function(t){this.debug("Moving to location "+t),this.player.setLocation(t),this.printLine(this.locations[this.player.getLocation()].text_on_visit),this.trigger(this.locations[this.player.getLocation()],"visit_trigger"),this.locations[this.player.getLocation()].visited=!0,this.checkForPrompt("this.locations."+this.player.getLocation()+".prompts")},TextAdventure.prototype.validateUse=function(t,e){this.debug("Testing objects for valid use: "+t+", "+e);var i,o,n,s,r=this.isObjectAvailable(t);if(!1===r)return this.printLine("There's no "+t+" to use","error"),!1;if(o=r[0],i=r[1],""===e)return i.can_use?this.resolvedDependency(t)?(this.printLine(i.text_on_use),this.locations[this.player.getLocation()].objects[o].is_used=!0,i.remove_after_use&&this.player.deleteItemFromInventory(o),this.usedObjects.push(o),this.trigger(i,"use_trigger"),!0):(this.printLine(i.text_on_error),!1):(!1!==i.can_use_on_object?(this.debug(t+" can not be used by itself"),this.printLine("The "+t+" can't be used that way.","error")):(this.debug(t+"can not be used at all"),this.printLine("The "+t+" can't be used.","error")),!1);var a=this.isObjectAvailable(e);if(!1!==a)return s=a[0],n=a[1],i.can_use_on_object===s?this.resolvedDependency(t)&&this.resolvedDependency(e)?(this.debug(t+" and "+e+"can be used together."),this.printLine(i.text_on_use_object_on),this.locations[this.player.getLocation()].objects[s].is_used=!0,i.remove_after_use&&this.player.deleteItemFromInventory(o),this.usedObjects.push(o),this.trigger(i,"use_trigger"),!0):(this.resolvedDependency(o)?this.resolvedDependency(s)||(this.debug(e+" has an unresolved dependency"),this.printLine(n.text_on_error)):(this.debug(t+" has an unresolved dependency"),this.printLine(i.text_on_error)),!1):(this.debug(t+" can not be used on "+e),this.printLine("Can't use the "+t+" that way.","error"),!1);this.printLine(e+" isn't here to use","error")},TextAdventure.prototype.validateExamine=function(t){this.debug("Testing "+t+" for examine");var e=this.isObjectAvailable(t);!1!==e?(this.printLine(e[1].description),this.trigger(e,"examine_trigger")):this.printLine(t+" is not something you can examine.","error")},TextAdventure.prototype.validatePickup=function(t){this.debug("Testing object "+t+" for picking up.");var e=this.isObjectAvailable(t);if(!1!==e){var i=e[0],o=e[1];return o.can_pickup?o.picked_up?(this.printLine("You have already picked up the "+t,"error"),!1):this.resolvedDependency(i)?(this.player.addItemToInventory(i,o),this.locations[this.player.getLocation()].objects[i].picked_up=!0,this.printLine("You put the "+o.name+" in your inventory"),this.trigger(o,"pickup_trigger"),!0):(this.printLine(o.text_on_error),!1):(this.printLine("You can't pick up the "+t,"error"),!1)}printLine(t+" can not be picked up.","error")},TextAdventure.prototype.checkForVictory=function(){var objId="";if(this.debug("***** VICTORY CONDITIONS CHECK *****"),""!==this.victoryConditions.conditions.in_location&&this.victoryConditions.conditions.in_location!==this.player.getLocation())return this.debug("Victory conditions not met: in location "+this.victoryConditions.conditions.in_location),!1;for(var i=0;i<this.victoryConditions.conditions.have_objects.length;i++)if(objId=this.victoryConditions.conditions.have_objects[i],!this.player.inInventory(objId))return this.debug("Victory conditions not met: have object "+objId),!1;var foundObj=!1;for(i=0;i<this.victoryConditions.conditions.used_objects.length;i++){objId=this.victoryConditions.conditions.used_objects[i];for(var j=0;j<this.usedObjects.length;j++)objId===this.usedObjects[j]&&(foundObj=!0);if(!foundObj)return this.debug("Victory conditions not met: used object "+objId),!1}var loc="",locVisited=!1;for(i=0;i<this.victoryConditions.conditions.visited_locations.length;i++){if(loc=this.victoryConditions.conditions.visited_locations[i],void 0===this.locations[loc].visited)return this.debug("Victory conditions not me: location "+loc+" not visited"),!1;if(!0!==this.locations[loc].visited)return this.debug("Victory conditions not me: location "+loc+" not visited"),!1}if(0<this.victoryConditions.conditions.has_responded.length){var responseIDs=[],responseString="",responseObj={};for(i=0;i<this.victoryConditions.conditions.has_responded.length;i++){responseIDs=this.victoryConditions.conditions.has_responded[i].split("."),responseString="this.locations."+responseIDs[0];for(var j=1;j<responseIDs.length;j++)responseString+=j%2==1?".prompts."+responseIDs[j]:".responses."+responseIDs[j];if(responseObj=eval(responseString),void 0===responseObj)return this.debug("Condition "+this.victoryConditions.conditions.has_responded[i]+" could not be found. Verify your game data."),!1;if(void 0===responseObj.is_chosen)return this.debug("Condition "+this.victoryConditions.conditions.has_responded[i]+" not met"),!1;if(!1===responseObj.is_chosen)return this.debug("Condition "+this.victoryConditions.conditions.has_responded[i]+" not met"),!1}}this.printLine(this.victoryConditions.victory_text,"victory"),this.inputField.disabled=!0,this.gameVictory=!0,this.trigger(this.victoryConditions,"victory_trigger")},TextAdventure.prototype.checkForPrompt=function(promptRef){if(this.debug("***** PROMPTS *****"),void 0!==eval(promptRef)){var promptObj=eval(promptRef);for(var prompt in promptObj){var promptCheck="";if(0<this.getCurrentPrompt().length&&(promptCheck=this.getCurrentPrompt()[1]),prompt===promptCheck)this.debug(prompt+" has just been shown.");else{var conditionsMet=!0;if(void 0!==promptObj[prompt].prompt_conditions){this.debug(prompt+" has conditions. Checking if they are met.");for(var responseIDs=[],responseString="",responseObj={},i=0;i<promptObj[prompt].prompt_conditions.length;i++){responseIDs=promptObj[prompt].prompt_conditions[i].split("."),responseString="this.locations."+responseIDs[0];for(var j=1;j<responseIDs.length;j++)responseString+=j%2==1?".prompts."+responseIDs[j]:".responses."+responseIDs[j];responseObj=eval(responseString),void 0===responseObj?(this.debug("Condition "+promptObj[prompt].prompt_conditions[i]+" could not be found. Verify your game data."),conditionsMet=!1):void 0!==responseObj.is_chosen?!1===responseObj.is_chosen&&(conditionsMet=!1,this.debug("Condition "+promptObj[prompt].prompt_conditions[i]+" not met")):(conditionsMet=!1,this.debug("Condition "+promptObj[prompt].prompt_conditions[i]+" not met"))}}if(!promptObj[prompt].has_prompted&&conditionsMet||promptObj[prompt].has_prompted&&promptObj[prompt].can_repeat&&conditionsMet)return this.debug("Showable prompt found: "+prompt),this.promptMode=!0,this.currentPrompt.push([promptRef,prompt]),this.printLine(promptObj[prompt].prompt_text,"prompt"),!0;this.debug("Prompt "+prompt+" can't be shown")}}return!1}for(this.debug("No pompt found"),this.debug("Checking for for follow-up prompts");0<this.currentPrompt.length;)return!!this.checkForPrompt(this.getCurrentPrompt()[0])||(this.removeLastPrompt(),!1)},TextAdventure.prototype.getCurrentPrompt=function(){return 0===this.currentPrompt.length?[]:this.currentPrompt[this.currentPrompt.length-1]},TextAdventure.prototype.removeLastPrompt=function(){this.currentPrompt.pop()},TextAdventure.prototype.resetPrompts=function(){this.currentPrompt=[]},TextAdventure.prototype.isObjectAvailable=function(t){var e="";if(this.player.inInventory(t))return debug(t+" found in inventory."),[e=this.player.getItemIDFromInventory(t),this.player.getItemFromInventory(e)];for(e in this.locations[this.player.getLocation()].objects)if(e===t||this.locations[this.player.getLocation()].objects[e].name.toLowerCase()===t)return this.debug(t+" found in location."),[e,this.locations[this.player.getLocation()].objects[e]];return this.debug(t+" not found."),!1},TextAdventure.prototype.findObjectInLocation=function(t){for(var e in this.locations[this.player.getLocation()].objects)if(this.locations[l].objects[e].name===t)return e;return!1},TextAdventure.prototype.resolvedDependency=function(t){var e;this.debug("**** DEPENDENCY TEST ****"),this.debug("Testing "+t+" for dependencies.");var i=isObjectAvailable(t);return!1!==i?(objID=i[0],""!==(e=i[1]).depends_on?this.locations[this.player.getLocation()].objects[e.depends_on].is_used?(this.debug("Has dependency, is resolved."),!0):(this.debug("Has dependency, is not resolved."),!1):(this.debug("Hasn't got a dependency."),!0)):""!==this.locations[this.player.getLocation()].directions[t].depends_on?(oD=this.locations[this.player.getLocation()].objects[this.locations[this.player.getLocation()].directions[t].depends_on],oD.is_used?(this.debug("Has dependency, is resolved."),!0):(this.debug("Has dependency, is not resolved."),!1)):(this.debug("Hasn't got a dependency."),!0)},TextAdventure.prototype.saveProgress=function(){this.canStore&&(this.storage.setObject("TA_LOCATIONS",this.locations),this.storage.setObject("TA_INVENTORY",this.player.getInventory()),this.storage.setItem("TA_CURRENTLOCATION",this.player.getLocation()))},TextAdventure.prototype.restart=function(){this.usedObjects=[],this.promptMode=!1,this.gameVictory=!1,this.currentPrompt=[],this.firstMessageDisplayed=!1,this.typedCommands=[],this.typedCommandsIndex=0,this.player={},this.canStore&&(this.storage.removeItem("TA_LOCATIONS"),this.storage.removeItem("TA_INVENTORY"),this.storage.removeItem("TA_CURRENTLOCATION")),this.inputField.disabled=!1,this.start()},TextAdventure.prototype.trigger=function(t,e){void 0!==t[e]&&(this.debug("Trigger "+e+" found"),void 0!==t[e].function_call&&""!==t[e].function_call&&this.extensions[t[e].function_call](t[e].function_parameters,this))},TextAdventure.prototype.displayHelp=function(){this.debug("Displaying help");var t="<p>Explore all locations, collect items and solve puzzles to beat the game. Here is a list of instructions you can use to get started:</p>";t+=this.buildDefinitionList({help:{description:"Displays this information"},inventory:{description:"Displays the items in your character's inventory"},"look around":{description:"Take a look at your current location."},go:{description:"Go in a specific direction (or to a specific location or object)"},"pick up":{description:"Pick up an object and put it in your inventory"},examine:{description:"Take a closer look at an object in your inventory or in your current location."},use:{description:"Use an object in your inventory or location (on a specific object)"}}),this.printLine(t,"help")},TextAdventure.prototype.displayInventory=function(){this.debug("Displaying the inventory");var t="<h2>Inventory</h2>";t+=buildDefinitionList(this.player.getInventory()),this.printLine(t,"inventory")},TextAdventure.prototype.printLine=function(t,e){if(void 0!==t&&""!==t){var i=document.createElement("div");i.className="dal-ta-output-item",void 0!==e&&(i.className+=" "+e);for(var o=0,n=0,s="",r="",a="";-1!==t.indexOf("[",o);)n=t.indexOf("[",o),s+=t.substring(o,n),o=n+1,n=t.indexOf("]",o),r=t.substring(o,n),o=n+2,n=t.indexOf(")",o),a=t.substring(o,n),o=n+1,s+='<span class="'+a+'">'+r+"</span>";s+=t.substring(o,t.length),i.innerHTML=s,this.outputContainer.appendChild(i),this.firstMessageDisplayed||(this.firstMessageDisplayed=!0,i.style.paddingTop=this.outputContainer.clientHeight-i.clientHeight+"px"),window.clearInterval(this.timer),this.timer=window.setInterval(this.animateScroll,this.timerInterval,this)}},TextAdventure.prototype.animateScroll=function(t){t.outputContainer.clientHeight>=t.outputContainer.scrollHeight-t.outputContainer.scrollTop?window.clearInterval(t.timer):t.outputContainer.scrollTop+=2},TextAdventure.prototype.showTypedCommand=function(t){0!==this.typedCommands.length&&(this.typedCommandsIndex+=t,this.typedCommandsIndex<0&&(this.typedCommandsIndex=this.typedCommands.length-1),this.typedCommandsIndex>=this.typedCommands.length&&(this.typedCommandsIndex=0),debug("showing typed command, index: "+this.typedCommandsIndex),this.inputField.value=this.typedCommands[this.typedCommandsIndex])},TextAdventure.prototype.buildDefinitionList=function(t){var e="<dl>";for(var i in t)e+=void 0===t[i].name?"<dt>"+i+"</dt>":"<dt>"+t[i].name+"</dt>",e+="<dd>"+t[i].description+"</dd>";return e+="</dl>"},TextAdventure.prototype.extend=function(t){this.extensions=t},TextAdventure.prototype.debug=function(t){!0===this.options.debug&&console.log(t)};